---
title: 限流算法
prev:
  text: 限流算法
  link: /algorithm/domain/限流算法.md
next:
  text: 限流算法
  link: /algorithm/domain/限流算法.md
---
::: info
&#8195;&#8195;限流的主要目的是通过限制并发访问数量或者限制一个时间窗口内允许处理的请求数量来保护系统，一旦达到限制数量则对当前请求进行处理采取对应的拒绝策略，比如跳转到错误页面拒绝请求进入、排队、降级等等。

&#8195;&#8195;限流的主要作用是损失一部分用户的可用性，为大部分用户提供可靠的服务。要实现限流，最重要的是限流算法，常见的限流算法有四种：计数器算法、滑动窗口算法、令牌桶算法、漏桶算法。
:::
[[toc]]
***

## 计数器算法
&#8195;&#8195;计数器算法是一种比较简单的限流算法，在指定的周期内累加访问次数，当访问次数达到设定的阈值时，触发限流政策。当进入下一个时间周期时，访问次数清零重新计数。

&#8195;&#8195;如图，先顶了每一分钟能够处理的总请求数是100，在第一个1min内，一共请求60次，在第二个1min内，counter从0开始重新计数，在时间刚到一半时达到请求阈值，这时候所有的请求都会被拒绝。

![计数器算法](/images/algorithm/domain/计数器算法.png)

&#8195;&#8195;这种算法比较适合于场景简单的限流场景，比如短信发送的频次限制上，比如限制同一个用户1min内只能发送一次短信。

&#8195;&#8195;**计数器算法存在一个临界问题**。比如还是上面的例子，在0:58-1:02之内分别出现了100个请求，整体看则是这4s内就出现了超过阈值200的请求。

![计数器算法临界问题](/images/algorithm/domain/计数器算法临界问题.png)

## 滑动窗口算法

&#8195;&#8195;为了解决计数器算法的临界问题，引入了滑动窗口算法。滑动窗口是一种流量控制技术，在TCP网络通信协议中，就采用了滑动创空算法来解决网络拥塞问题。

&#8195;&#8195;简单来说，滑动窗口算法就是在固定的窗口中分割出多个小时间窗口，分别在每个时间窗口中记录访问次数，然后根据时间将窗口往前滑动并且删除过期的小时间窗口。最终只统计滑动窗口范围内的所有小时间窗口总的计数即可。

&#8195;&#8195;如图所示，将计数器算法的时间窗口拆分为4个小时间窗口，每个小时间窗口只能处理25个请求。并且通过虚线框表示滑动窗口的大小(下图所示的滑动窗口是2，最多只能处理50个请求)。同时滑动窗口会向前移动，比如在15s结束后，滑动窗口移动到15s-45s的范围内，然后在新的窗口中重新统计数据。

&#8195;&#8195;**滑动窗口算法可以很好地解决计数器算法的临界问题**。

![滑动窗口算法](/images/algorithm/domain/滑动窗口算法.png)

## 令牌桶算法

&#8195;&#8195;n，对于每一个请求，都需要从令牌桶中获得一个令牌，如果没有获得令牌，则触发限流策略。

&#8195;&#8195;如图所示，系统会以恒定的速率往固定容量的令牌桶中放入令牌，如果此时客户端请求进来，则需要先从桶中拿到令牌来获得访问资格。

![令牌桶算法](/images/algorithm/domain/令牌桶算法.png)

&#8195;&#8195;假设令牌的生成速度是10s/个，也就是QPS=10，此时请求获取令牌的时候会存在三种情况：
- 请求速度大于令牌生成速度：令牌很快被取完，后续的请求被限流。
- 请求速度等于令牌生成速度：流量处于平稳状态。
- 请求速度小于令牌生成速度：系统的并发数不高，请求被正常处理。


&#8195;&#8195;**由于令牌桶是固定容量，如果请求速度小于令牌生成速度，令牌桶会被填满。所以令牌桶能够处理突发流量，也就是短时间内新增的系统流量能够正常处理**。

## 漏桶算法
&#8195;&#8195;漏桶算法主要作用是控制数据注入网络的速度，平滑网络上的突发流量(削峰)。

&#8195;&#8195;如图所示，漏铜也是维护一个容器，这个容器会以恒定的速度流出水，不管上面注入速度多快，流出速度始终不变。这但很像消息中间件，不管生产者的请求量多大，消息的处理能力取决于消费者的消费能力。

![漏桶算法](/images/algorithm/domain/漏桶算法.png)

&#8195;&#8195;在漏桶算法中，存在一下几种情况：
- 请求速度大于漏桶流出的速度：即请求数量超过当前服务的处理能力，触发限流政策。
- 请求速度小于或者等于桶流出的速度：满足客户端的处理速度，请求可以正常执行。

&#8195;&#8195;**漏桶算法与令牌桶算法的实现原理相差不大，最大区别是漏桶算法无法处理短时内流量突发的情况，是一种恒定速度的限流算法**。
