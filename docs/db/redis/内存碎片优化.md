Redis还有一个常见的问题：数据明明删除了，为什么内存占用率依然很高？这是因为，Redis数据删除后，内存空间会由内存分配器进行管理，并不会立即返回给操作系统。

这里有个潜在的风险点，Redis释放的内存空间可能不是连续的，这些空闲空间Redis无法进行数据保存。

# 内存碎片的产生

## 内因：内存分配器的分配策略

Redis可以使用libc、jemalloc、tcmalloc等多种内存分配器分配内存，通常使用jemalloc进行内存分配。

jemalloc的分配策略之一是按照固定大小划分内存，如8字节、16字节、32字节、...、2KB、4KB、8KB等等，当申请的内存接近于某个固定值时，将申请固定大小的值。

## 外因：键值对大小不一样和删改操作

对于已经储存的键值对会修改或者删除，如果有修改或者删除操作，也会修改已经申请的内存空间的大小，导致空间的扩容或者释放。

这样就会产生空闲空间。

# 如何判断是否有内存碎片

通过INFO MEMORY 命令可以查看内存使用情况。有一个指标**mem_fragmentation_ratio**是可以查看内存空间。

* **大于1小于1.5**：内存使用情况合理。
* **大于1.5**：内存碎片率超过了50%，需要进行清理。
# 如何清理内存碎片

可以使用内存清理的配置进行清理，同过配置文件进行配置。

