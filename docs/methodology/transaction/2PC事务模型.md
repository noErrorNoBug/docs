---
title: 2PC事务模型
prev:
  text: X_OPEN事务模型
  link: /methodology/transaction/X_OPEN事务模型.md
next:
  text: 3PC事务模型
  link: /methodology/transaction/3PC事务模型.md
---
::: info
&#8195;&#8195;两阶段提交是一种非常基础的保证数据一致性的方案，ZAB协议、Raft协议等都是通过两阶段提交保证数据一致性。

&#8195;&#8195;事务的提交分为两个阶段，首先是**提交事务请求**阶段，之后才是**执行事务提交**阶段。
:::
[[toc]]

***

![2PC原理](/images/methodology/2PC原理.png)

## 阶段一：提交事务请求

1. 事务询问：
事务协调者向所有事务参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应。

2. 执行事务：
各参与者节点执行事务操作（不提交，锁定资源），并把undo和redo日志记录到事务日志中。

3. 各参与者向事务协调者反馈事务询问响应：
如果参与者成功执行了实务操作，就反馈给事务协调者Yes响应，表示事务可以执行；如果参与者没有执行成功事务，反馈给协调者NO响应，表示事务不可以执行。

## 阶段二：执行事务提交

&#8195;&#8195;阶段二也叫做投票阶段，分为两种结果：执行事务提交和中断事务。

### 执行事务提交

&#8195;&#8195;如果所有的参与者返回给协调者的响应都是Yes，那么就会执行事务提交：

1. 发送提交请求：
协调者向所有的参与者节点发送 Commit 请求。

2. 事务提交：
参与者收到 Commit 请求后，会正式执行事务提交操作，并在完成提交之后释放整个事务执行期间占用的事务资源。

3. 反馈事务提交结果：
参与者完成事务提交后，向协调者发送 Ack 消息。

4. 完成事务：
协调者接收到所有参与者反馈的Ack消息后，完成事务。

### 中断事务

&#8195;&#8195;任何一个参与者向协调者反馈了一个NO响应，或者在等待超时之后，协调者尚无法收到所有参与者的响应，那么事务就会中断：

1. 发送回滚请求：
协调者向所有参与者节点发出rollback请求。

2. 事务回滚：
参与者接收到Rollback请求后，会利用其在阶段一种的Undo记录信息来执行事务回滚操作，并在完成回滚后释放整个事务周期占用的资源。

3. 反馈事务回滚结果：
参与者完成事务回滚后，向协调者发送Ack消息。

4. 中断事务：
协调者接收到所有参与者反馈的Ack消息后，完成事务中断。

## 优缺点

* 优点：
    * 原理简单，实现方便
* 缺点：
    * 同步阻塞：阶段二提交的所有过程中，参与事务操作的逻辑都处于阻塞状态，也就是所有的参与者都在等待其他参与者的响应。
    * 单点问题：协调者的作用非常重要，一旦出现问题，阶段二的参与者的事务会一直处于锁定状态中。
    * 脑裂问题：阶段二事务提交时如果出现问题，那么会出现脑裂导致数据不一致。
    * 过于保守：任何一个参与者节点的失败都会导致回滚。

