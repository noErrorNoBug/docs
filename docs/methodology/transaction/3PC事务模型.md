---
title: 3PC事务模型
prev:
  text: 2PC事务模型
  link: /methodology/transaction/2PC事务模型.md
next:
  text: TCC事务补偿方案
  link: /methodology/transaction/TCC事务补偿方案.md
---
::: info
&#8195;&#8195;3PC也就是三阶段提交，是二阶段提交的演化版本，将提交事务请求划分为两个阶段，总共分成了三个阶段：canCommit、PreCommit和doCommit。
:::
[[toc]]

***

![3PC原理](/images/methodology/3PC原理.png)


## CanCommit

1. 事务询问：
协调者向所有参与者发送一个事务内容的canCommit请求，询问是否可以执行事务提交操作，并开始等待参与者的响应。

2. 参与者向协调者反馈事务询问响应：
参与者接收到canCommit请求后，正常情况下，确认自身是否可以顺利执行事务，如果可以执行则返回Yes响应，并且进入预备状态；否则返回No响应。

## PreCommit

&#8195;&#8195;阶段二中，协调者根据参与者的反馈情况决定是否进行PreCommit，正常情况下有两种情况：

### 执行事务预提交

1. 发送与提交请求：
协调者向所有的参与者节点发出preCommit请求，进入Prepared阶段。

2. 事务预提交：
参与者接收到preCommit请求后，执行事务操作，将Undo和Redo信息记录到事务日志中。

3. 各参与者向协调者反馈事务执行的响应：
如果参与者成功执行了事务操作，就会返回给协调者Ack响应，同时等待最终操作：提交或者终止。

### 中断事务

&#8195;&#8195;如果阶段一中任何一个参与者返回No响应或者超时，就会执行中断事务。

1. 发送中断请求：
协调者向所有参与者节点发送abort请求。

2. 中断事务：
无论是收到abort请求或者是等待协调者响应的过程中超时，都进行中断事务。

## doCommit

&#8195;&#8195;该阶段进行事务的提交，会存在两种情况：

### 执行提交

1. 发送提交请求：
协调者接收到了所有参与者在第二阶段的ack响应，那么就会从预提交转换为提交状态，并且向所有的参与者发送doCommit请求。

2. 事务提交：
参与者收到doCommit请求后，正式执行事务提交操作，并且在提交完成后释放事务执行期间占用的资源。

3. 反馈事务提交结果：
参与者在完成事务提交以后，向协调者发送Ack消息。

4. 完成事务：
协调者接收到所有参与者反馈的Ack消息后，完成事务。

### 中断事务

如果第二阶段有任何一个参与者返回No或者接收响应超时，那么进行事务中断操作。

1. 发送中断请求：
协调者向所有参与者节点发送abort请求。

2. 事务回滚：
参与者收到abort请求后，会利用第二阶段的Undo信息执行事务回滚操作，并在完成回滚后释放整个事务执行期间占用的资源。

3. 反馈事务回滚结果：
参与者完成事务回滚之后，向协调者发送Ack消息。

4. 中断事务：
协调者接收到所有参与者看亏的Ack消息后，中断事务。

# 优缺点

* 优点：相比于二阶段提交，最大优点是减少了参与者的阻塞范围，能够在单点故障后迅速达成一致。
* 缺点：如果二阶段的时候出现了因为网络分区或者其他问题导致无法与协调者正常通信，参与者依然会进行事务提交导致数据不一致。


