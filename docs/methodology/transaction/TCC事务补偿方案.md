---
title: TCC事务补偿方案
prev:
  text: 3PC事务模型
  link: /methodology/transaction/3PC事务模型.md
next:
  text: 基于可靠消息的最终一致性方案
  link: /methodology/transaction/基于可靠消息的最终一致性方案.md
---
::: info
&#8195;&#8195;TCC是一种比较成熟的分布式系统数据一致性的解决方案，是一种最终一致性的解决方案。
:::
[[toc]]

***

## 原理
&#8195;&#8195;TCC（Try-Confirm-Cancel）是一种比较成熟的分布式一致性解决方案，实际上是把业务拆分成如下三个步骤：

1. Try：这个阶段主要是对**数据**进行**校验**或者**资源的预留**。
2. Confirm：确认真正执行任务，只操作Try阶段预留的资源。
3. Cannel：取消执行，释放Try阶段预留的资源。

![TCC事务补偿方案](/images/methodology/TCC事务补偿方案.png)

&#8195;&#8195;其实**TCC是一种两阶段提交的思想**，第一阶段通过Try进行准备工作，第二阶段Confirm/Cannel表示Try阶段的资源确认/回滚。

&#8195;&#8195;在分布式事务的场景中，**每个服务实现TCC之后，服务就作为其中一个资源，参与到整个分布式事务中**。然后主服务在第一个阶段中调用TCC服务的Try方法。最后根据第一阶段的执行情况来决定第二阶段对Confirm或者Cannel的调用。

&#8195;&#8195;**TCC服务应该支持接口调用失败发起重试，所以TCC暴露的接口都必须要满足幂等性**。

## 实现
&#8195;&#8195;在实现方面，应该遵循以下几点：

1. 所有的TCC服务的接口都必须满足Try-Confirm-Cancel的规范，提供相应的功能。
2. TCC服务的接口应该支持调用失败重试，所以必须要满足幂等性。
3. 事务协调器或者主服务记录操作日志，用于人工干预、操作记录、触发回滚等一系列的操作。
4. 事务协调器应该根据操作日志进行重试，以达到最终一致性。
