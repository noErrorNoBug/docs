---
title: UUA认证中心实现案例
prev:
  text: UUA认证中心实现案例
  link: /projects/uua/UUA认证中心实现案例.md
next:
  text: UUA认证中心实现案例
  link: /projects/uua/UUA认证中心实现案例.md
---
::: info
&#8195;&#8195;并不是所有的系统都可以对外无限开放，及时是内部系统，大部分资源仍旧是需要保护的。对于分布式系统而言，认证中心是比较核心的系统之一，在应用层，认证中心服务应满足大部分的权限需求。下面介绍一下认证中心的架构
:::
[[toc]]
***

## 系统架构
&#8195;&#8195;下图是认证中心的架构图，此认证中心技术栈以Spring Cloud Security为主，图中省略了注册中心、负载均衡、限流等其他功能：

![认证中心架构设计](/images/microservice/auth/认证中心架构设计.png)

&#8195;&#8195;如上图所示，采用在网关层进行权限拦截的方式，网关采用Spring Cloud项目的[Gateway项目](../../microservice/gateway/Gateway核心原理.md)。网关层作为认证服务中资源服务的一种，主要承担资源权限的拦截功能和请求的初步校验和过滤。

&#8195;&#8195;用户请求打到网关上，对于可以放行的资源如商城的主页、商品页，后台的注册、登录页面直接放行交由认证中心服务处理。对于受保护的资源，请求转发至认证中进行认证，后续根据认证结果返回或者放行，其原理详见文章[SpringSecurity实现OOS](../../microservice/auth/SpringSecurity实现OOS.md)。

&#8195;&#8195;认证中心的核心功能包括：注册、登录(身份)认证、权限认证的核心功能。
- 注册功能由消息队列配合短信、邮箱服务实现，并且需要分布式事务与用户中心同步相关联数据。
- 登录认证需要实现OOS，采用Redis作为分布式Session存储，存放用户信息、登录信息、权限信息供给全局使用。
- 登录会注册全局监听器，监听用户行为，并提供审计数据。
- 权限认证支持Oauth2的5种认证模式，并支持jwt的token使用，访问受保护资源应携带颁发的有效令牌。
- 提供SDK支持资源服务进行二次验证，并获得用户权限信息。

## 用户注册流程

![注册流程](/images/microservice/auth/注册流程.png)

&#8195;&#8195;注册流程主要包含三个大流程：生成图形验证码、手机或邮箱的验证码流程和创建用户流程。**用户注册流程有3个核心点需要注意**：
1. **分布式Session**：注册过程中需要生成一个注册用户的全局Session，用于存储注册信息。
2. **数据强一致性**：注册成功后，认证信息、权限信息部分与用户中心是重叠的，因此需要同步数据。注册操作不是高并发操作，可以使用分布式事务组件保证事务的强一致性。
3. **登录后认证**：用户注册成功后，应该立即进行认证并颁发令牌，以保证重定向后的资源能够得到有效访问，避免用户出现注册后无权访问的情形。

## 认证授权

![认证授权流程](/images/microservice/auth/认证授权流程.png)

&#8195;&#8195;认证授权流程包含了三部分内容：用户登录认证、接入第三方认证和Oauth2认证。其中接入第三方认证需要遵循第三方认证的标准，可以参考微信、支付宝或者微博的相关认证流程进行开发即可，不做赘述。

&#8195;&#8195;[Oauth2认证流程](../microservice/auth/Oauth2协议详解.md)可以参考相关文章和[集成方案]((../microservice/auth/SpringSecurityOauth2核心原理.md))，这里也不再重复说明。

&#8195;&#8195;这里需要着重说明的是：
- **分布式Session**：分布式Session用来存储token信息、用户信息、权限信息，是用来实现OSS也就是单点登录的核心。
  - 分布式系统中，认证中心的集群服务无法再像单体服务一样在服务端存储Session，因此需要使用分布式Session的方案，这里我们使用Redis作为存储介质(当然也可以使用MongoDB等其他分布式存储方案)。
  - 分布式Session一方面需要存储授权信息用于单点用户的授权，另一方面也作为用户登录状态的体现。
- **token编码**：token作为资源访问的“钥匙”，此处使用Jwt作为编码方案，但是仍需要认证中心进行验证，并不完全依靠jwt本身存储的信息。
  - 一方面，如果所有信息存储在jwt生成的token中，token过于冗余。
  - 另一方面，从安全角度讲，也不可以将敏感信息存放在token中。
- **token类型**：这里会生成两种token，access_token和id_token。
  - access_token：授权时返回给用户的token，用于单点用户后续资源访问时携带，用于权限认证。
  - id_token：服务内部调用的二次认证token，此id_token在access_token从网关转发到认证中心认证后生成，向下游服务器访问时，由网关替换access_token，仅仅用于内部访问二次认证，不向外暴露。
- **其他功能集成**：在授权功能中，除了最终要的分布式Session，还应该实现禁用、下线等前置操作的检查以及后置操作如注册全局监听的实现。

## 访问受保护资源流程

![访问受保护资源流程](/images/microservice/auth/访问受保护资源流程.png)

&#8195;&#8195;访问受保护资源流程主要包括两部分：一般情况下的访问受保护资源，只需要在网关转发请求前去认证中心授权即可；二次验证的资源需要认证中心通过二次认证的Session来保证有效期内二次认证的授权可用性，因此会有额外的授权步骤。

&#8195;&#8195;同时需要注意的是，在服务集群内部，依旧是使用id_token作为令牌，access_token只作为对外的“钥匙”。这样有利于使用access_token只做“身份证”使用，id_token则可以携带必要的信息，敏感信息也不会暴露出去。

